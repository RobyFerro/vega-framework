# vega migrate

Manage database schema migrations with Alembic once SQLAlchemy support is enabled.

## Usage

```bash
vega migrate <command> [OPTIONS]
```

Available commands:

| Command | Purpose |
|---------|---------|
| `init` | Create database tables defined by the current models |
| `create` | Generate a new Alembic revision using autogenerate |
| `upgrade` | Apply migrations up to a target revision |
| `downgrade` | Roll migrations back to a previous revision |
| `current` | Show the currently applied revision |
| `history` | Display migration history |

All commands proxy Alembic under the hood, so an `alembic.ini` and `alembic/` directory must exist (generated by `vega add sqlalchemy`).

## Prerequisites

- Run `vega add sqlalchemy` (or `vega add db`) to scaffold Alembic and the database manager.
- Install dependencies:
  ```bash
  poetry add sqlalchemy alembic
  ```
- Configure your database URL in `settings.py` and ensure `config.py` registers `db_manager`.

## Commands

### init

```bash
vega migrate init
```

Runs `db_manager.create_tables()` to create all tables defined by your SQLAlchemy models. Useful for the first-time bootstrap or testing environments.

### create

```bash
vega migrate create -m "Add orders table"
```

Generates a new migration revision using Alembic autogeneration. The `-m/--message` flag is required.

### upgrade

```bash
vega migrate upgrade
vega migrate upgrade ae12f3c4d5
```

Applies migrations up to the specified revision (defaults to `head`). Output from Alembic is streamed back to your terminal.

### downgrade

```bash
vega migrate downgrade -1
vega migrate downgrade base
```

Rolls back migrations. The default target is `-1`, which reverts one step.

### current

```bash
vega migrate current
```

Shows the currently applied revision.

### history

```bash
vega migrate history
```

Displays the migration timeline produced by Alembic using the verbose output that includes branch and dependency information.

## Recommended Workflow

```bash
vega add sqlalchemy
poetry add sqlalchemy alembic
vega migrate init                     # Create tables
vega migrate create -m "Initial"      # Generate first revision
vega migrate upgrade                  # Apply it
```

With migrations in place you can continue to evolve your models and rely on Alembic to track schema changes across environments.
