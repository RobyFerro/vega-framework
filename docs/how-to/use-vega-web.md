# Build HTTP APIs with Vega Web

Vega includes a lightweight HTTP framework that feels familiar to FastAPI while staying
fully aligned with Clean Architecture. This guide shows how to scaffold, configure, and
extend the Vega Web module in your projects.

## Prerequisites

- Python 3.10+
- `vega-framework` installed (ships with Starlette and Uvicorn dependencies)
- A Vega project created via `vega init ...`

> To add web capabilities to an existing project run `vega add web`. New projects can be
> bootstrapped with `vega init my-api --template web`, which wires the same scaffold
> automatically.

## Project Layout

When the web scaffold is enabled you get the following structure:

```
presentation/
    web/
        app.py          # Vega Web application factory
        main.py         # ASGI entrypoint (`app` instance)
        routes/         # HTTP routers
        middleware/     # Route-level middleware (optional)
        models/         # Pydantic request/response DTOs
```

- `presentation/web/app.py` exposes `create_app()` that builds and configures a `VegaApp`.
- `presentation/web/main.py` instantiates the app for Uvicorn or `vega web run`.
- Routers inside `presentation/web/routes/` are automatically discovered and registered.

## Creating Routes

Use `VegaApp` for top-level handlers or group endpoints inside `Router` instances:

```python
# presentation/web/routes/users.py
from vega.web import Router, HTTPException, status

router = Router(prefix="/api/users")

@router.get("/{user_id}")
async def get_user(user_id: str):
    user = await GetUser(user_id=user_id)  # interactor invocation
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found",
        )
    return {"id": user.id, "name": user.name}

@router.post("")
async def create_user(request):
    payload = await request.json()
    user = await CreateUser(**payload)
    return {"id": user.id}
```

Key points:

- Decorators mirror the FastAPI style: `get`, `post`, `put`, `delete`, `patch`, and `route`.
- Return dictionaries/pydantic models for automatic `JSONResponse` serialization, or return
  any `Response` subclass.
- Raise `HTTPException` (from `vega.web`) for error responses; `vega.web.status` exposes
  familiar HTTP status codes.

### Request Object

Import `Request` from `vega.web` when you need access to the incoming request:

```python
from vega.web import Request

@router.post("/upload")
async def upload_file(request: Request):
    data = await request.json()
    file = await request.form()
    # Access headers via `request.headers`, query parameters via `request.query_params`
    ...
```

The object wraps Starlette’s request API and is compatible with existing utilities.

## Assembling the Application

Routers are composed inside `presentation/web/app.py`:

```python
from vega.web import VegaApp
from .routes import register_routes  # auto-discovery helper generated by the CLI

def create_app() -> VegaApp:
    app = VegaApp(
        title="My Service",
        version="1.0.0",
        debug=True,
    )

    register_routes(app)  # includes routers found under presentation/web/routes
    return app

app = create_app()
```

You can also include routers manually:

```python
from .routes import users, health

def create_app() -> VegaApp:
    app = VegaApp(title="Example API")
    app.include_router(users.router)
    app.include_router(health.router)
    return app
```

## Middleware

### Application Middleware

Reuse Starlette-compatible middleware classes through `app.add_middleware`:

```python
from starlette.middleware.cors import CORSMiddleware

def create_app() -> VegaApp:
    app = VegaApp(title="Example API")

    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_methods=["*"],
        allow_headers=["*"],
    )

    return app
```

### Route-Level Middleware

`vega.web.route_middleware` adds per-route middleware chains with explicit phases:

```python
from vega.web import middleware
from vega.web.route_middleware import RouteMiddleware, MiddlewarePhase

class AuditMiddleware(RouteMiddleware):
    def __init__(self):
        super().__init__(phase=MiddlewarePhase.BOTH)

    async def before(self, request):
        request.state.audit_id = generate_request_id()

    async def after(self, request, response):
        response.headers["X-Audit-ID"] = request.state.audit_id
        return response

@router.post("/orders")
@middleware(AuditMiddleware())
async def create_order(request: Request):
    ...
```

Built-in helpers live in `vega.web.builtin_middlewares`:

- `AuthMiddleware` – validate bearer tokens before handlers run.
- `TimingMiddleware` – log and expose processing time.
- `LoggingMiddleware` – request/response logging.
- `CacheControlMiddleware`, `CORSMiddleware`, `RateLimitMiddleware` – common patterns ready to use.

Combine multiple middleware objects by stacking them in the decorator:

```python
@router.get("/users/{user_id}/profile")
@middleware(AuthMiddleware(), TimingMiddleware())
async def profile(user_id: str):
    ...
```

## Responses and Exceptions

Vega wraps Starlette responses for convenience. Import what you need from `vega.web`:

```python
from vega.web import JSONResponse, HTMLResponse, FileResponse

@router.get("/export")
async def export_users():
    data = await ExportUsers()
    return JSONResponse(data)
```

For error handling, raise `HTTPException` with a status code and detail message. Additional
exceptions like `NotFoundError`, `BadRequestError`, and `ValidationError` are provided for
common scenarios.

## Running the Server

Two easy options:

```bash
# Inside the project directory
poetry run vega web run --reload        # Uses presentation/web/main.py

# Or start Uvicorn manually
poetry run uvicorn presentation.web.main:app --reload
```

`vega web run` automatically loads `config.py`, adds the project root to `sys.path`, and
starts Uvicorn with sensible defaults.

## Testing

Because Vega Web is Starlette-based you can use the familiar test client:

```python
from starlette.testclient import TestClient
from presentation.web.main import app

client = TestClient(app)

def test_health():
    response = client.get("/health/status")
    assert response.status_code == 200
    assert response.json() == {"status": "ok"}
```

For asynchronous tests reach for `httpx.AsyncClient` paired with `asgi_lifespan` to exercise
startup/shutdown hooks.

## Next Steps

- Explore `vega.web.route_middleware` and `vega.web.builtin_middlewares` for advanced
  behaviour.
- Generate routers, middleware, and DTOs via `vega generate router`, `vega generate middleware`,
  and `vega generate webmodel`.
- Combine Vega Web with interactors and mediators to keep delivery and business logic separate.

